{%- comment -%}
  Simple AdSense include
  Props:
    kind: leaderboard | skyscraper | rectangle | square | in-article | feed | multiplex
    size: optional (e.g., large, medium, small, responsive, billboard, horizontal, vertical)
    align: left|center|right (default center)
    label: accessible caption (default "Advertisement")
    full: true|false (default true)
    slot: override slot id (optional, bypasses data file)
{%- endcomment -%}

{%- assign kind = include.kind | default: 'rectangle' -%}
{%- assign size = include.size -%}
{%- assign align = include.align | default: 'center' -%}
{%- assign full  = include.full  | default: true -%}
{%- assign label = include.label | default: 'Advertisement' -%}

{%- assign slot = include.slot -%}
{%- if slot == nil -%}
  {%- assign group = site.data.ads[kind] -%}
  {%- if group and group.size > 0 -%}
    {%- if size -%}
      {%- assign match = group | where: 'size', size | first -%}
      {%- assign slot = match.slot | default: group[0].slot -%}
    {%- else -%}
      {%- assign slot = group[0].slot -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%}
  Determine AdSense format from kind
{%- endcomment -%}
{%- assign _type = 'display' -%}
{%- if kind == 'in-article' -%}
  {%- assign _type = 'in-article' -%}
{%- elsif kind == 'feed' -%}
  {%- assign _type = 'in-feed' -%}
{%- elsif kind == 'multiplex' -%}
  {%- assign _type = 'multiplex' -%}
{%- endif -%}

{%- if slot == nil -%}
  <div class="crma-ad crma-ad--error">Ad not configured (kind: {{ kind }}, size: {{ size | default: 'default' }})</div>
{%- else -%}
  <figure
    class="crma-ad crma-ad--{{ _type }} crma-ad--{{ kind | replace: ' ', '-' }} crma-ad--align-{{ align }}{% if full %} crma-ad--full{% endif %}"
    role="figure"
    aria-label="{{ label | escape }}"
    data-kind="{{ kind }}"
    data-size="{{ size | default: 'default' }}"
  >
    <figcaption class="crma-ad__label" aria-hidden="true">{{ label }}</figcaption>
    <div class="crma-ad__ph" aria-hidden="true"></div>

    <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="{{ site.adsense.publisher_id }}"
      data-ad-slot="{{ slot }}"
      {%- if _type == 'display' -%}
        data-ad-format="auto"
        data-full-width-responsive="true"
      {%- elsif _type == 'in-article' -%}
        data-ad-format="fluid"
        data-ad-layout="in-article"
      {%- elsif _type == 'in-feed' -%}
        data-ad-format="fluid"
        data-ad-layout-key="-g1+1o-3k-5u"
      {%- elsif _type == 'multiplex' -%}
        data-ad-format="autorelaxed"
      {%- endif -%}
      loading="lazy">
    </ins>

    <script>
      (function lazyAdsense(root){
        if (!root) return;
        if (!window.adsbygoogle) { window.adsbygoogle = window.adsbygoogle || []; }

        var ins = root.querySelector('ins.adsbygoogle');
        var fire = function(){ try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e){} };

        if (!('IntersectionObserver' in window)) { fire(); return; }

        var fired = false;
        var io = new IntersectionObserver(function(es){
          es.forEach(function(e){
            if (!fired && e.isIntersecting) { fired = true; fire(); io.disconnect(); }
          });
        }, { rootMargin: '200px 0px', threshold: 0.01 });

        io.observe(ins);
      })(document.currentScript.closest('.crma-ad'));
    </script>
  </figure>
{%- endif -%}
