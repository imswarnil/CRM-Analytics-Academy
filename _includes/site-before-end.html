<!-- Overwrite this file with code you want before the closing body tag -->
<script>
    (function() {
    let searchData = []; // This will hold our Jekyll search data.

    document.addEventListener('DOMContentLoaded', function () {
        
        // --- FETCH JEKYLL SEARCH DATA ---
        fetch('{{ "/assets/search.json" | relative_url }}')
            .then(blob => blob.json())
            .then(data => {
                searchData = data;
                console.log('Search data loaded.');
            })
            .catch(error => console.error('Error fetching search data:', error));

        // --- DYNAMIC CONTENT (Mostly moved to Jekyll) ---
        // We'll keep pagination and related posts here for demonstration
        const paginationContainer = document.querySelector('.pagination');
        if (paginationContainer) {
            paginationContainer.innerHTML = `<a href="#" class="prev"><i class="ph-duotone ph-arrow-left"></i><div><div style="font-size: 0.8rem; color: var(--docs-muted-foreground);">Previous</div><div>Installation</div></div></a><a href="#" class="next"><div><div style="font-size: 0.8rem; color: var(--docs-muted-foreground);">Next</div><div>Layout</div></div><i class="ph-duotone ph-arrow-right"></i></a>`;
        }

        // --- COPY CODE BUTTON ---
        document.querySelectorAll('pre').forEach(pre => {
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);

            const btn = document.createElement('button');
            btn.className = 'copy-button';
            btn.innerHTML = '<i class="ph-duotone ph-copy"></i> Copy';
            wrapper.appendChild(btn);
            
            const code = pre.querySelector('code').innerText;
            btn.addEventListener('click', () => {
                navigator.clipboard.writeText(code).then(() => {
                    btn.innerHTML = '<i class="ph-duotone ph-check"></i> Copied!';
                    setTimeout(() => { btn.innerHTML = '<i class="ph-duotone ph-copy"></i> Copy'; }, 2000);
                });
            });
        });
        
        // --- TOC & SCROLLSPY ---
        const headings = document.querySelectorAll('article h2[id]');
        if (headings.length > 0) {
            const desktopToc = document.querySelector('.desktop-toc-container');
            const mobileTocContent = document.querySelector('.mobile-toc-content');
            const mobileTocList = document.createElement('ol');

            headings.forEach(h => {
                const link = document.createElement('a');
                link.href = `#${h.id}`;
                link.textContent = h.textContent;

                // For Desktop
                if (desktopToc) {
                    const dt = link.cloneNode(true);
                    dt.classList.add('toc-link');
                    desktopToc.appendChild(dt);
                }

                // For Mobile
                if (mobileTocContent) {
                    const li = document.createElement('li');
                    li.appendChild(link.cloneNode(true));
                    mobileTocList.appendChild(li);
                }
            });

            if (mobileTocContent) mobileTocContent.appendChild(mobileTocList);

            const observer = new IntersectionObserver(entries => entries.forEach(i => {
                if (i.isIntersecting) {
                    const id = i.target.id;
                    document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll(`.toc-link[href="#${id}"]`).forEach(l => l.classList.add('active'));
                }
            }), { rootMargin: `-100px 0px -50% 0px`, threshold: .1 });
            headings.forEach(h => observer.observe(h));
        }
        
        // --- MOBILE SIDENAV ---
        const menuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar-left');
        const mobileOverlay = document.getElementById('mobile-overlay');
        const closeMenu = () => {
            sidebar.classList.remove('is-open');
            mobileOverlay.classList.remove('is-active');
            document.body.classList.remove('modal-open');
        };
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('is-open');
            mobileOverlay.classList.toggle('is-active');
            document.body.classList.toggle('modal-open');
        });
        mobileOverlay.addEventListener('click', closeMenu);
        
        // --- DARK MODE ---
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            const htmlEl = document.documentElement;
            const setTheme = t => {
                htmlEl.classList.toggle('dark', t === 'dark');
                themeToggle.querySelector('i').className = t === 'dark' ? 'ph-duotone ph-moon' : 'ph-duotone ph-sun';
                localStorage.setItem('theme', t);
            };
            setTheme(localStorage.getItem('theme') || 'light');
            themeToggle.addEventListener('click', () => setTheme(htmlEl.classList.contains('dark') ? 'light' : 'dark'));
        }
        
        // --- SEARCH MODAL (JEKYLL INTEGRATED) ---
        const searchModal = document.getElementById('search-modal');
        const searchTrigger = document.getElementById('search-trigger');
        const searchOverlay = searchModal.querySelector('.search-overlay');
        const searchInput = document.getElementById('search-input');
        const resultsContainer = searchModal.querySelector('.search-results');
        let activeResultIndex = -1;

        const openSearch = () => {
            searchModal.classList.add('is-open');
            document.body.classList.add('modal-open');
            setTimeout(() => searchInput.focus(), 50);
            renderResults('');
        };
        const closeSearch = () => {
            searchModal.classList.remove('is-open');
            document.body.classList.remove('modal-open');
            searchInput.value = '';
        };

        const renderResults = query => {
            const term = query.trim().toLowerCase();
            let filteredResults = [];
            if (term.length > 1) {
                const regex = new RegExp(term, 'gi');
                filteredResults = searchData.filter(item => 
                    item.title.match(regex) || item.excerpt.match(regex)
                );
            }
            
            resultsContainer.innerHTML = '';
            activeResultIndex = -1;
            
            if (term.length > 1 && filteredResults.length === 0) {
                resultsContainer.innerHTML = '<div class="search-no-results">No results found.</div>';
                return;
            }
            if (filteredResults.length > 0) {
                const ul = document.createElement('ul');
                filteredResults.slice(0, 10).forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'search-result-item';
                    li.dataset.index = index;
                    li.innerHTML = `<a href="${item.url}">
                        <div style="flex-shrink: 0; width: 32px; text-align: center;"><i class="ph-duotone ph-file-text"></i></div>
                        <div style="flex-grow: 1;">
                            <div style="font-weight:600;">${item.title}</div>
                            <div style="font-size: 0.875rem; color: var(--docs-muted-foreground);">${item.excerpt}</div>
                        </div>
                    </a>`;
                    ul.appendChild(li);
                });
                resultsContainer.appendChild(ul);
            }
        };
        
        const updateActive = (newIndex) => {
            const items = resultsContainer.querySelectorAll('.search-result-item');
            if (items.length === 0) return;
            if (activeResultIndex > -1 && items[activeResultIndex]) {
                items[activeResultIndex].classList.remove('active');
            }
            if (newIndex >= items.length) newIndex = 0;
            if (newIndex < 0) newIndex = items.length - 1;
            if (items[newIndex]) {
                items[newIndex].classList.add('active');
                items[newIndex].scrollIntoView({ block: 'nearest' });
            }
            activeResultIndex = newIndex;
        };

        searchTrigger.addEventListener('click', openSearch);
        searchOverlay.addEventListener('click', closeSearch);
        searchInput.addEventListener('input', () => renderResults(searchInput.value));
        
        document.addEventListener('keydown', e => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
            if (searchModal.classList.contains('is-open')) {
                if (e.key === 'Escape') closeSearch();
                if (e.key === 'ArrowDown') { e.preventDefault(); updateActive(activeResultIndex + 1); }
                if (e.key === 'ArrowUp') { e.preventDefault(); updateActive(activeResultIndex - 1); }
                if (e.key === 'Enter') {
                    const activeLink = resultsContainer.querySelector('.search-result-item.active a');
                    if (activeLink) activeLink.click();
                }
            }
        });
    });
})();
</script>